# Qwen3-1.7B åŒ»å­¦é—®ç­”å¾®è°ƒé¡¹ç›®

åŸºäºQwen3-1.7Bæ¨¡å‹çš„åŒ»å­¦é—®ç­”ç³»ç»Ÿå¾®è°ƒé¡¹ç›®ï¼Œæ”¯æŒå…¨å‚æ•°å¾®è°ƒå’ŒLoRAå¾®è°ƒä¸¤ç§æ–¹å¼ã€‚

## ğŸš€ é¡¹ç›®ç‰¹æ€§

- **ä¸‰é˜¶æ®µè®­ç»ƒ**ï¼šæ”¯æŒå…¨å‚æ•°å¾®è°ƒã€LoRAå¾®è°ƒå’ŒRLå¼ºåŒ–å­¦ä¹ 
- **åŒ»å­¦ä¸“ä¸šé—®ç­”**ï¼šé’ˆå¯¹åŒ»å­¦åœºæ™¯ä¼˜åŒ–çš„é—®ç­”ç³»ç»Ÿ
- **æ€è€ƒé“¾ç”Ÿæˆ**ï¼šæ¨¡å‹è¾“å‡ºåŒ…å«æ˜¾å¼æ€è€ƒè¿‡ç¨‹ï¼ˆ`<think>`æ ‡ç­¾ï¼‰
- **DeepSeekæ•™å¸ˆè¾…åŠ©**ï¼šRLé˜¶æ®µä½¿ç”¨DeepSeekæ¨¡å‹ä½œä¸ºå¥–åŠ±è¯„åˆ†æ•™å¸ˆ
- **å¤šç»´å¥–åŠ±å‡½æ•°**ï¼šç»“åˆè§„åˆ™å¥–åŠ±å’ŒAIæ•™å¸ˆè¯„åˆ†çš„ç»„åˆå¥–åŠ±ç³»ç»Ÿ
- **Webç•Œé¢**ï¼šåŸºäºGradioçš„äº¤äº’å¼æ¼”ç¤ºç•Œé¢
- **æ‰¹é‡æ¨ç†**ï¼šæ”¯æŒæ‰¹é‡é¢„æµ‹å’Œè¯„ä¼°
- **è‡ªåŠ¨è¯„ä¼°**ï¼šåŒ…å«å¤šç§è¯„ä¼°æŒ‡æ ‡çš„è‡ªåŠ¨åŒ–è¯„ä¼°ç³»ç»Ÿ

## ğŸ“‹ ç¯å¢ƒè¦æ±‚

- Python 3.8+
- CUDA 11.8+ (æ¨è)
- å†…å­˜: 16GB+ (å…¨å‚æ•°å¾®è°ƒéœ€è¦æ›´å¤š)
- æ˜¾å­˜: 8GB+ (LoRAå¾®è°ƒ), 16GB+ (å…¨å‚æ•°å¾®è°ƒ)

## ğŸ› ï¸ å®‰è£…ä¾èµ–

```bash
pip install -r requirements.txt
```

## ğŸ“ é¡¹ç›®ç»“æ„

```
â”œâ”€â”€ models/                    # æ¨¡å‹æ–‡ä»¶ç›®å½•
â”‚   â”œâ”€â”€ full/                 # å…¨å‚æ•°å¾®è°ƒæ¨¡å‹
â”‚   â”œâ”€â”€ lora/                 # LoRAå¾®è°ƒæ¨¡å‹
â”‚   â””â”€â”€ rl/                   # RLè®­ç»ƒæ¨¡å‹ï¼ˆNEWï¼‰
â”œâ”€â”€ data/                     # æ•°æ®ç›®å½•
â”‚   â”œâ”€â”€ raw/                  # åŸå§‹æ•°æ®
â”‚   â”œâ”€â”€ processed/            # å¤„ç†åæ•°æ®ï¼ˆSFTï¼‰
â”‚   â””â”€â”€ rl/                   # RLè®­ç»ƒæ•°æ®ï¼ˆNEWï¼‰
â”‚       â”œâ”€â”€ training_prompts.jsonl
â”‚       â”œâ”€â”€ teacher_judgements.jsonl
â”‚       â””â”€â”€ reward_rules.md
â”œâ”€â”€ scripts/                  # è„šæœ¬æ–‡ä»¶
â”‚   â”œâ”€â”€ prepare_data.py       # æ•°æ®é¢„å¤„ç†ï¼ˆSFTï¼‰
â”‚   â”œâ”€â”€ prepare_rl_data.py    # RLæ•°æ®å‡†å¤‡ï¼ˆNEWï¼‰
â”‚   â”œâ”€â”€ train_full.py         # å…¨å‚æ•°å¾®è°ƒè®­ç»ƒ
â”‚   â”œâ”€â”€ train_lora.py         # LoRAå¾®è°ƒè®­ç»ƒ
â”‚   â”œâ”€â”€ train_ppo.py          # PPOå¼ºåŒ–å­¦ä¹ è®­ç»ƒï¼ˆNEWï¼‰
â”‚   â”œâ”€â”€ deepseek_teacher.py   # DeepSeekæ•™å¸ˆè¯„åˆ†ï¼ˆNEWï¼‰
â”‚   â”œâ”€â”€ reward_fn.py          # å¥–åŠ±å‡½æ•°ï¼ˆNEWï¼‰
â”‚   â”œâ”€â”€ batch_predict.py      # æ‰¹é‡é¢„æµ‹
â”‚   â”œâ”€â”€ demo_gradio.py        # Webæ¼”ç¤ºç•Œé¢
â”‚   â””â”€â”€ eval_auto.py          # è‡ªåŠ¨è¯„ä¼°
â”œâ”€â”€ docs/                     # æ–‡æ¡£ç›®å½•
â”‚   â”œâ”€â”€ rl_quickstart.md      # RLå¿«é€Ÿå…¥é—¨ï¼ˆNEWï¼‰
â”‚   â””â”€â”€ ...
â”œâ”€â”€ reports/rl_stage/         # RLé˜¶æ®µæŠ¥å‘Šï¼ˆNEWï¼‰
â”‚   â”œâ”€â”€ feasibility_report.md
â”‚   â””â”€â”€ implementation_progress.md
â”œâ”€â”€ requirements.txt          # ä¾èµ–åŒ…åˆ—è¡¨
â””â”€â”€ README.md                # é¡¹ç›®è¯´æ˜
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### é˜¶æ®µ1: SFTï¼ˆç›‘ç£å¾®è°ƒï¼‰

#### 1.1 æ•°æ®å‡†å¤‡

**é€‰æ‹©æ•°æ®é›†ï¼ˆæ¨èç”¨äºRLï¼‰**:

```bash
# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
source .venv/bin/activate

# æ–¹å¼1: ä½¿ç”¨medical-o1æ•°æ®é›†ï¼ˆæ¨èç”¨äºRLï¼ŒåŒ…å«æ¨ç†é“¾ï¼‰
python scripts/prepare_data_multi_source.py medical-o1

# æ–¹å¼2: ä½¿ç”¨åŸå§‹æ•°æ®é›†
python scripts/prepare_data.py

# æ–¹å¼3: æ··åˆå¤šä¸ªæ•°æ®æº
python scripts/prepare_data_multi_source.py medical-o1,datatang-qa
```

**æ¨èæ•°æ®é›†**ï¼š
- **FreedomIntelligence/medical-o1-reasoning-SFT** (æœ€é€‚åˆRL) - åŒ…å«å®Œæ•´æ¨ç†é“¾
- **krisfu/delicate_medical_r1_data** (åŸå§‹) - å·²é€‚é…ä»£ç 
- **DatatangBeijing/203029Groups-ChineseMedicalQuestionAnsweringData** (å¤§è§„æ¨¡)

è¯¦è§ï¼š[æ•°æ®é›†é€‰æ‹©æŒ‡å—](docs/dataset_selection_guide.md)

#### 1.2 SFTè®­ç»ƒ

**LoRAå¾®è°ƒï¼ˆæ¨èï¼‰**

```bash
python scripts/train_lora.py
```

**å…¨å‚æ•°å¾®è°ƒ**

```bash
python scripts/train_full.py
```

### é˜¶æ®µ2: RLï¼ˆå¼ºåŒ–å­¦ä¹ ï¼‰ğŸ†•

#### 2.1 å‡†å¤‡RLæ•°æ®

```bash
# ç”ŸæˆRLè®­ç»ƒæç¤ºï¼ˆä¼˜å…ˆé«˜é£é™©æ ·æœ¬ï¼‰
python scripts/prepare_rl_data.py
```

#### 2.2 é…ç½®DeepSeekæ•™å¸ˆï¼ˆå¯é€‰ï¼‰

```bash
# è®¾ç½®APIå¯†é’¥
export DEEPSEEK_API_KEY="your_api_key_here"

# æµ‹è¯•æ•™å¸ˆæ¨¡å—
python scripts/deepseek_teacher.py --limit 5
```

**æ³¨**: å¦‚æœæ²¡æœ‰APIå¯†é’¥ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ä½¿ç”¨Mockæ¨¡å¼è¿›è¡Œè®­ç»ƒã€‚

#### 2.3 PPOè®­ç»ƒ

```bash
python scripts/train_ppo.py
```

**è¯¦ç»†æ•™ç¨‹**: å‚è§ [docs/rl_quickstart.md](docs/rl_quickstart.md)

### é˜¶æ®µ3: æ¨¡å‹æ¨ç†

#### æ‰¹é‡é¢„æµ‹

```bash
python scripts/batch_predict.py
```

#### Webç•Œé¢æ¼”ç¤º

```bash
python scripts/demo_gradio.py
```

è®¿é—® http://localhost:7860 è¿›è¡Œäº¤äº’å¼æµ‹è¯•ã€‚

### 4. æ¨¡å‹è¯„ä¼°

```bash
python scripts/eval_auto.py
```

## ğŸ“Š æ•°æ®è¯´æ˜

é¡¹ç›®ä½¿ç”¨`krisfu/delicate_medical_r1_data`æ•°æ®é›†ï¼ŒåŒ…å«ï¼š

### SFTé˜¶æ®µæ•°æ®
- **è®­ç»ƒé›†** (80%): ç”¨äºç›‘ç£å¾®è°ƒ
- **éªŒè¯é›†** (10%): ç”¨äºæ¨¡å‹éªŒè¯
- **æµ‹è¯•é›†** (10%): ç”¨äºæ¨¡å‹æµ‹è¯•
- **é»„é‡‘æ ‡å‡†é›†**: ä»éªŒè¯é›†å’Œæµ‹è¯•é›†ä¸­ç²¾é€‰çš„é«˜è´¨é‡æ ·æœ¬
- **çº¢é˜Ÿæµ‹è¯•é›†**: äººå·¥æ„å»ºçš„é«˜é£é™©æµ‹è¯•ç”¨ä¾‹

### RLé˜¶æ®µæ•°æ®ğŸ†•
- **training_prompts.jsonl**: RLè®­ç»ƒæç¤ºï¼ˆä¼˜å…ˆé«˜é£é™©+é«˜è´¨é‡æ ·æœ¬ï¼‰
- **teacher_judgements.jsonl**: DeepSeekæ•™å¸ˆè¯„åˆ†ç¼“å­˜
- **reward_rules.md**: å¥–åŠ±å‡½æ•°é…ç½®æ–‡æ¡£

æ•°æ®æ ¼å¼éµå¾ªæŒ‡ä»¤å¾®è°ƒçš„æ ‡å‡†æ ¼å¼ï¼š
```json
{
    "instruction": "ä½ æ˜¯ä¸€ä¸ªåŒ»å­¦ä¸“å®¶ï¼Œä½ éœ€è¦æ ¹æ®ç”¨æˆ·çš„é—®é¢˜ï¼Œç»™å‡ºå¸¦æœ‰æ€è€ƒçš„å›ç­”ã€‚",
    "input": "ç”¨æˆ·é—®é¢˜",
    "output": "<think>æ€è€ƒè¿‡ç¨‹</think>\nåŒ»å­¦å»ºè®®",
    "meta": {
        "source": "æ•°æ®æ¥æº",
        "risk_level": "é£é™©ç­‰çº§",
        "specialty": "ä¸“ç§‘é¢†åŸŸ",
        "complexity": "å¤æ‚åº¦",
        "lang_style": "è¯­è¨€é£æ ¼",
        "is_deidentified": true
    }
}
```

## ğŸ¯ è¯„ä¼°æŒ‡æ ‡

### SFTé˜¶æ®µè¯„ä¼°
- **æ€è€ƒé“¾è¦†ç›–ç‡**: è¾“å‡ºåŒ…å«`<think>`æ ‡ç­¾çš„æ¯”ä¾‹
- **ç´§æ€¥ä¿¡å·è¦†ç›–ç‡**: åŒ…å«å°±åŒ»æŒ‡å¾æç¤ºçš„æ¯”ä¾‹
- **é£é™©å¤„æ–¹ç‡**: åŒ…å«ä¸å½“è¯ç‰©å»ºè®®çš„æ¯”ä¾‹

### RLé˜¶æ®µå¥–åŠ±ğŸ†•

**ç»„åˆå¥–åŠ±å…¬å¼**:
```
R = 0.6 Ã— R_rules + 0.4 Ã— R_teacher
```

**è§„åˆ™å¥–åŠ± (R_rules)**:
- æ ¼å¼å¥–åŠ±: `<think>`æ ‡ç­¾å­˜åœ¨ (+0.2)
- å†…å®¹å¥–åŠ±: åŒ…å«"å»ºè®®"ã€"è¯Šæ–­"ç­‰å…³é”®è¯ (+0.1)
- é•¿åº¦æƒ©ç½š: å›ç­”è¿‡çŸ­ (-0.5)

**æ•™å¸ˆå¥–åŠ± (R_teacher)** - ç”±DeepSeekè¯„åˆ†:
- å®‰å…¨æ€§ (40%): æ˜¯å¦æœ‰è¯¯å¯¼ã€æ¼è¯Š
- é€»è¾‘æ€§ (30%): æ¨ç†é“¾æ˜¯å¦ä¸¥å¯†
- å®Œæ•´æ€§ (20%): æ˜¯å¦è¦†ç›–é‰´åˆ«è¯Šæ–­
- åŒç†å¿ƒ (10%): è¯­æ°”æ˜¯å¦æ°å½“

è¯¦è§: [data/rl/reward_rules.md](data/rl/reward_rules.md)

## ğŸ”§ é…ç½®è¯´æ˜

### ä¸‰é˜¶æ®µè®­ç»ƒæµç¨‹ğŸ†•

```
æ•°æ®å‡†å¤‡ â†’ SFTè®­ç»ƒ â†’ RLè®­ç»ƒ
   â†“          â†“         â†“
  JSONL   LoRAæ¨¡å‹   RLæ¨¡å‹
```

1. **SFTé˜¶æ®µ**: å­¦ä¹ åŸºç¡€åŒ»å­¦çŸ¥è¯†å’Œæ€è€ƒé“¾æ ¼å¼
2. **RLé˜¶æ®µ**: é€šè¿‡å¼ºåŒ–å­¦ä¹ ä¼˜åŒ–å®‰å…¨æ€§å’Œé€»è¾‘æ€§
3. **è¯„ä¼°**: åœ¨gold_setå’Œred_teamä¸Šå¯¹æ¯”SFT vs RLæ€§èƒ½

### è®­ç»ƒå‚æ•°

#### LoRAå¾®è°ƒå‚æ•°
- `r=64`: LoRAç§©
- `lora_alpha=128`: LoRAç¼©æ”¾å‚æ•°
- `lora_dropout=0.1`: LoRA dropoutç‡
- `learning_rate=2e-4`: å­¦ä¹ ç‡
- `num_train_epochs=3`: è®­ç»ƒè½®æ•°

#### å…¨å‚æ•°å¾®è°ƒå‚æ•°
- `learning_rate=5e-6`: å­¦ä¹ ç‡
- `num_train_epochs=1`: è®­ç»ƒè½®æ•°
- `gradient_accumulation_steps=8`: æ¢¯åº¦ç´¯ç§¯æ­¥æ•°

#### PPOè®­ç»ƒå‚æ•°ğŸ†•
- `learning_rate=1.41e-5`: å­¦ä¹ ç‡
- `batch_size=4`: æ‰¹æ¬¡å¤§å°
- `mini_batch_size=1`: PPO mini-batch
- `target_kl=0.1`: KLæ•£åº¦é˜ˆå€¼
- `ppo_epochs=4`: æ¯æ‰¹æ•°æ®çš„è®­ç»ƒè½®æ•°

### æ¨¡å‹é…ç½®

åœ¨è„šæœ¬ä¸­å¯ä»¥åˆ‡æ¢ä½¿ç”¨ä¸åŒçš„æ¨¡å‹ï¼š

```python
# ä½¿ç”¨å…¨å‚æ•°å¾®è°ƒæ¨¡å‹
MODEL_DIR = "models/full/final_model"
IS_LORA = False

# ä½¿ç”¨LoRAå¾®è°ƒæ¨¡å‹
BASE_DIR = "models/Qwen/Qwen3-1.7B"
ADAPTER_DIR = "models/lora/final_lora"
IS_LORA = True
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **åŒ»å­¦å…è´£å£°æ˜**: æœ¬ç³»ç»Ÿä»…ç”¨äºç ”ç©¶å’Œå­¦ä¹ ç›®çš„ï¼Œä¸åº”ç”¨äºå®é™…åŒ»ç–—è¯Šæ–­
2. **æ•°æ®è„±æ•**: æ‰€æœ‰è®­ç»ƒæ•°æ®å·²è¿›è¡Œè„±æ•å¤„ç†
3. **ç´§æ€¥æƒ…å†µ**: é‡åˆ°ç´§æ€¥åŒ»ç–—æƒ…å†µè¯·ç«‹å³å°±åŒ»
4. **èµ„æºè¦æ±‚**: å…¨å‚æ•°å¾®è°ƒéœ€è¦å¤§é‡è®¡ç®—èµ„æºï¼Œå»ºè®®ä¼˜å…ˆä½¿ç”¨LoRAå¾®è°ƒ

## ğŸ¤ è´¡çŒ®æŒ‡å—

æ¬¢è¿æäº¤Issueå’ŒPull Requestæ¥æ”¹è¿›é¡¹ç›®ï¼

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨MITè®¸å¯è¯ - è¯¦è§ [LICENSE](LICENSE) æ–‡ä»¶

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **RLå¿«é€Ÿå…¥é—¨**: [docs/rl_quickstart.md](docs/rl_quickstart.md)
- **RLå¯è¡Œæ€§åˆ†æ**: [reports/rl_stage/feasibility_report.md](reports/rl_stage/feasibility_report.md)
- **RLå®æ–½è¿›åº¦**: [reports/rl_stage/implementation_progress.md](reports/rl_stage/implementation_progress.md)
- **å¥–åŠ±è§„åˆ™**: [data/rl/reward_rules.md](data/rl/reward_rules.md)

## ğŸ™ è‡´è°¢

- [Qwenå›¢é˜Ÿ](https://github.com/QwenLM/Qwen) æä¾›çš„ä¼˜ç§€åŸºç¡€æ¨¡å‹
- [ModelScope](https://modelscope.cn/) æä¾›çš„æ•°æ®é›†å’Œæ¨¡å‹ä¸‹è½½æœåŠ¡
- [TRLåº“](https://github.com/huggingface/trl) æä¾›çš„å¼ºåŒ–å­¦ä¹ æ¡†æ¶
- [DeepSeek](https://www.deepseek.com/) æä¾›çš„AIè¯„åˆ†æœåŠ¡
- åŒ»å­¦é¢†åŸŸçš„ä¸“å®¶å’Œç ”ç©¶è€…ä»¬æä¾›çš„å®è´µæ•°æ®

## ğŸ“ è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·é€šè¿‡GitHub Issuesè”ç³»ã€‚
